name: build-images

on: [push, pull_request]

jobs:
  build-x86:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        HERCULES_SERVER_MODE: ["classic", "renewal"]
        HERCULES_PACKET_VERSION: ["20180418", ""]

    steps:
      - name: Check out repo
        uses: actions/checkout@v2
        # ARCH=${arch} HERCULES_SERVER_MODE=${mode} HERCULES_PACKET_VERSION=${packetver} docker-compose up

      - name: Build Hercules
        run: |
          docker-compose up

      - name: Build image
        uses: mr-smithers-excellent/docker-build-push@v3
        with:
          image: florianpiesche/hercules-${matrix.HERCULES_SERVER_MODE}-${matrix.HERCULES_PACKET_VERSION:-default}
          tag: amd64
          registry: docker.io
          dockerfile: hercules_${matrix.HERCULES_SERVER_MODE}_packetver-${matrix.HERCULES_PACKET_VERSION}_${amd64}/Dockerfile
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
            
  build-arm:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        HERCULES_SERVER_MODE: ["classic", "renewal"]
        HERCULES_PACKET_VERSION: ["20180418", ""]
        ARCH: ["armv7", "aarch64"]
    steps:
      - name: Check out repo
        uses: actions/checkout@v2
        # ARCH=${arch} HERCULES_SERVER_MODE=${mode} HERCULES_PACKET_VERSION=${packetver} docker-compose up

      - name: Build Hercules
      - uses: uraimo/run-on-arch-action@v1.0.9
        with:
          architecture: ${matrix.ARCH}
          distribution: ubuntu18.04
          run: |
            docker-compose up

      - name: Build image
        uses: mr-smithers-excellent/docker-build-push@v3
        with:
          image: florianpiesche/hercules-${matrix.HERCULES_SERVER_MODE}-${matrix.HERCULES_PACKET_VERSION:-default}
          tag: ${matrix.ARCH}
          registry: docker.io
          dockerfile: hercules_${matrix.HERCULES_SERVER_MODE}_packetver-${matrix.HERCULES_PACKET_VERSION}_${matrix.ARCH}/Dockerfile
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
